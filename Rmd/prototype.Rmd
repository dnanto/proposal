---
params:
  root: "../exp/hex"
  db: "10508"
  entry: "FJ643676"
  range: "18233-21073"
  pidn: 90
---

```{r setup, include=F}
library(tidyverse)
source("../R/mutt.R")
knitr::opts_chunk$set(echo = F)
do.call(Sys.setenv, params)
```

Local Alignment

```{bash}
mkdir -p "$root"
blastdbcmd -db "$db" -entry "$entry" -range "$range" > "$root/qry.fna"
blastn \
  -task blastn -num_threads 8 -max_target_seqs 20000 \
  -db "$db" -query "$root/qry.fna" -outfmt 7 > "$root/blast.tsv"
```

Global/Local Alignment

```{bash}
awk '/^[^#]/ { print $2; }' "$root/blast.tsv" | uniq > "$root/acc.txt"
blastdbcmd -db "$db" -entry_batch "$root/acc.txt" > "$root/lib.fna"
glsearch36 -m 8CB -T 8 "$root/qry.fna" "$root/lib.fna" > "$root/glsearch.tsv"
```

Extract

```{bash}
rm -f "$root/lib.fna.fai"
awk -v id="$pidn" '/^[^#]/ && $3 >= id { printf "%s:%d-%d\n", $2, $9, $10; }' "$root/glsearch.tsv" | \
  samtools faidx "$root/lib.fna" -r - > "$root/reg.fna"
```

Multiple Alignment

```{bash}
mafft --auto --adjustdirection --thread -1 "$root/reg.fna" > "$root/msa.fna" 2> "$root/msa.log"
```

MUTT

```{r, fig.width=10, fig.height=4}
msa <- 
  file.path(params$root, "msa.fna") %>%
  ape::read.dna(format = "fasta", as.character = T) %>% 
  toupper()
msa <- msa[2:nrow(msa), ]

df.snp <- call_snp(msa)
df.ind <- call_ind(msa)

ggplot() +
  geom_point(data = df.snp, aes(pos, id, shape = call, color = call), size = 8) +
  geom_point(data = df.ind, aes(pos, id, shape = call), size = 4, position = position_nudge(y = 0.25)) +
  scale_shape_manual(values = setNames(
    c(124, 124, 124, 124, 6, 2), 
    c("trs", "trv", "sim", "dis", "ins", "del")
  )) +
  xlim(1, ncol(msa)) + 
  theme_minimal() + 
  theme(legend.position = "bottom")
```
