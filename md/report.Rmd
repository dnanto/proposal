---
title: "report"
output: html_document
params:
  root: ../out
---

```{r setup, include=FALSE}
library(ggtree)
library(tidyverse)
library(tracerer)
library(parallel)
knitr::opts_chunk$set(echo = TRUE)
options(mc.cores = detectCores())
```

```{r}
path_to_meta <- function(df)
{
  mutate_at(df, "path", str_remove, str_c("^", params$root, .Platform$file.sep, "?")) %>%
    separate(path, c("acc", "beast", "name"), .Platform$file.sep) %>%
    separate(name, c("clock", "coalescent"), "[-.]", extra = "drop") %>%
    select(-beast)
}

parse_mle_report <- function(path)
{
  lines <- read_lines(path)
  PS = "log marginal likelihood (using path sampling) from pathLikelihood.delta = "
  SS = "log marginal likelihood (using stepping stone sampling) from pathLikelihood.delta = "
  list(
    path = path,
    PS = as.double(str_sub(lines[startsWith(lines, PS)], nchar(PS) + 1)),
    SS = as.double(str_sub(lines[startsWith(lines, SS)], nchar(SS) + 1))
  )
}

df.mle <-
  list.files(params$root, pattern = ".mle.result.log", recursive = T, full.names = T) %>%
  lapply(parse_mle_report) %>%
  bind_rows() %>%
  path_to_meta() %>%
  select(acc, clock, coalescent, PS, SS) %>%
  group_by(acc) %>%
	mutate(
		`BF (PS)` = PS - PS[which(clock == "str" & coalescent == "con")],
		`BF (SS)` = SS - SS[which(clock == "str" & coalescent == "con")]
	) %>%
  ungroup() %>%
  arrange(acc, desc(`BF (PS)`))
```

```{r}
pburn <- 0.1
df.ess <-
  list.files(params$root, pattern = "\\w+-\\w+.log", recursive = T, full.names = T) %>%
  mclapply(function(path) {
    df <- parse_beast_log(path)
    interval <- df$state[2] - df$state[1]
    select(df, joint, prior, likelihood, age.root., meanRate, coalescent) %>%
      apply(2, function(ele) calc_ess(remove_burn_in(ele, pburn), interval)) %>%
      c(path = path)
  }) %>% 
  map_df(bind_rows) %>%
  path_to_meta() %>%
  select(acc, clock, coalescent, everything())
```

```{r}
merge(df.mle, df.ess, by = c("acc", "clock", "coalescent"), sort = F)
```


